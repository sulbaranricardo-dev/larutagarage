<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaderboard Pro | La Ruta Garage</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --neon: #d8ff5e; --bg: #050505; --glass: rgba(20, 20, 20, 0.8); }
        body { background: var(--bg); color: white; font-family: 'Montserrat', sans-serif; margin: 0; overflow-x: hidden; }
        
        /* HEADER COMPACTO */
        .header { text-align: center; padding: 20px 10px; background: linear-gradient(180deg, rgba(216, 255, 94, 0.1) 0%, transparent 100%); }
        .logo { width: 80px; margin-bottom: 5px; }
        
        .container { max-width: 600px; margin: auto; padding: 10px; }

        /* FILTROS COMPACTOS */
        .filters { display: flex; gap: 5px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: none; }
        .filters::-webkit-scrollbar { display: none; }
        .filter-btn { background: #111; border: 1px solid #333; color: white; padding: 8px 15px; border-radius: 20px; font-size: 0.7rem; white-space: nowrap; cursor: pointer; font-weight: 700; }
        .filter-btn.active { background: var(--neon); color: black; border-color: var(--neon); }

        /* PODIO RESALTADO */
        .podium-box { display: flex; align-items: flex-end; justify-content: center; gap: 10px; margin: 30px 0; }
        .podium-item { background: var(--glass); border-radius: 15px; padding: 15px 10px; text-align: center; flex: 1; border: 1px solid #333; position: relative; }
        
        /* PRIMER LUGAR CON BRILLO */
        .p-1 { 
            order: 2; transform: scale(1.15); border-color: var(--neon); z-index: 10;
            box-shadow: 0 0 20px rgba(216, 255, 94, 0.3);
            background: linear-gradient(145deg, rgba(216, 255, 94, 0.1), rgba(0,0,0,0.8));
        }
        .p-1::after {
            content: ''; position: absolute; top: -2px; left: -2px; right: -2px; bottom: -2px;
            border-radius: 15px; background: linear-gradient(45deg, transparent, var(--neon), transparent);
            z-index: -1; animation: rotate 3s linear infinite; opacity: 0.5;
        }
        @keyframes rotate { 0% { filter: hue-rotate(0deg); } 100% { filter: hue-rotate(360deg); } }

        .p-2 { order: 1; } .p-3 { order: 3; }
        .podium-photo { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid #555; margin-bottom: 8px; }
        .p-1 .podium-photo { width: 70px; height: 70px; border-color: var(--neon); }
        .podium-rank { font-weight: 900; font-size: 1.2rem; display: block; }

        /* TABLA COMPACTA */
        .lb-row { 
            display: flex; align-items: center; background: rgba(255,255,255,0.03); 
            margin-bottom: 4px; padding: 8px 12px; border-radius: 8px; gap: 12px;
        }
        .rank-num { width: 25px; font-weight: 900; color: #555; font-size: 0.8rem; }
        .atleta-img { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; border: 1px solid #333; }
        .atleta-info { flex-grow: 1; }
        .atleta-info strong { font-size: 0.8rem; text-transform: uppercase; display: block; }
        .atleta-info small { font-size: 0.6rem; color: #666; font-weight: 700; }
        .result-val { font-weight: 900; color: var(--neon); font-size: 0.9rem; }

        /* BOT√ìN COMPARTIR INNOVADOR */
        .btn-share { 
            background: #fff; color: #000; border: none; padding: 10px 20px; border-radius: 30px;
            font-weight: 800; font-size: 0.7rem; margin: 20px auto; display: flex; align-items: center; gap: 8px;
            cursor: pointer; transition: 0.3s;
        }
        .btn-share:hover { transform: scale(1.05); }

        .loading { text-align: center; color: var(--neon); font-size: 0.7rem; letter-spacing: 2px; padding: 50px; }
    </style>
</head>
<body>

<div class="header">
    <img src="https://firebasestorage.googleapis.com/v0/b/d-clan-athletes.firebasestorage.app/o/La%20Ruta%20Garage%2FLogo%20Icono%20Verde.png?alt=media&token=07ce2638-9667-4bad-8de1-c38abc5112f8" class="logo">
    <h1>LEADERBOARD LIVE</h1>
</div>

<div class="container">
    <div class="filters">
        <button class="filter-btn active" onclick="setEvent('race', this)">RUTA RACE</button>
        <button class="filter-btn" onclick="setEvent('crossfit', this)">CROSSFIT</button>
        <button class="filter-btn" onclick="setSexo('Masculino', this)">HOMBRES</button>
        <button class="filter-btn" onclick="setSexo('Femenino', this)">MUJERES</button>
    </div>

    <div id="podiumArea" class="podium-box"></div>

    <div id="loader" class="loading">SINCRONIZANDO RESULTADOS...</div>

    <div id="lb-list"></div>

    <button class="btn-share" onclick="compartirLeaderboard()">
        <i class="fas fa-share-nodes"></i> COMPARTIR POSICIONES
    </button>
</div>

<script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyKOZQgueIrJ63Mfxp6Pz87dbVFgQmDgOjKcU990nOMqjuDphoM4UOvrKKkpbWQTwYp/exec";
    let allData = [];
    let currentEvent = 'race';
    let currentSexo = 'todos';

    // Funci√≥n de formato de imagen (la que ya te funciona)
    function formatImgUrl(url) {
        if (!url || url === "") return "https://via.placeholder.com/150?text=Atleta";
        let id = "";
        if (url.includes("id=")) id = url.split("id=")[1].split("&")[0];
        else if (url.includes("file/d/")) id = url.split("file/d/")[1].split("/")[0];
        return id !== "" ? "https://lh3.googleusercontent.com/d/" + id : url;
    }

    async function cargar() {
        try {
            // Cacheamos los datos localmente para que los filtros sean instant√°neos
            const res = await fetch(WEB_APP_URL + "?t=" + new Date().getTime());
            allData = await res.json();
            document.getElementById('loader').style.display = 'none';
            renderizar();
        } catch (e) { console.error(e); }
    }

    function setEvent(ev, btn) {
        currentEvent = ev;
        actualizarActivo(btn, 0, 1);
        renderizar();
    }

    function setSexo(sex, btn) {
        currentSexo = (currentSexo === sex) ? 'todos' : sex;
        btn.classList.toggle('active');
        renderizar();
    }

    function actualizarActivo(btn, start, end) {
        const btns = document.querySelectorAll('.filter-btn');
        for(let i=start; i<=end; i++) btns[i].classList.remove('active');
        btn.classList.add('active');
    }

    function renderizar() {
        const listCont = document.getElementById('lb-list');
        const podiumCont = document.getElementById('podiumArea');
        
        let filtrados = allData.filter(a => {
            const mEv = a.modalidad && a.modalidad.toLowerCase().includes(currentEvent);
            const mSx = currentSexo === 'todos' || a.sexo === currentSexo;
            const tieneRes = a.resultado && a.resultado !== "";
            return mEv && mSx && tieneRes && a.estatus === "Aprobado";
        });

        // Ordenar
        if(currentEvent === 'race') {
            filtrados.sort((a, b) => String(a.resultado).localeCompare(String(b.resultado)));
        } else {
            filtrados.sort((a, b) => parseFloat(b.resultado) - parseFloat(a.resultado));
        }

        // Render Podio
        podiumCont.innerHTML = "";
        const top3 = filtrados.slice(0, 3);
        top3.forEach((a, i) => {
            const div = document.createElement('div');
            div.className = `podium-item p-${i+1}`;
            div.innerHTML = `
                <span class="podium-rank">${i+1}¬∞</span>
                <img src="${formatImgUrl(a.fotoCarnet)}" class="podium-photo">
                <strong style="font-size:0.6rem; display:block;">${a.nombre}</strong>
                <span style="color:var(--neon); font-weight:900; font-size:0.7rem;">${a.resultado}</span>
            `;
            podiumCont.appendChild(div);
        });

        // Render Lista
        listCont.innerHTML = "";
        filtrados.slice(3).forEach((a, i) => {
            const row = document.createElement('div');
            row.className = "lb-row";
            row.innerHTML = `
                <div class="rank-num">${i + 4}</div>
                <img src="${formatImgUrl(a.fotoCarnet)}" class="atleta-img">
                <div class="atleta-info">
                    <strong>${a.nombre} ${a.apellido}</strong>
                    <small>#${a.dorsal} | ${a.box || 'IND.'}</small>
                </div>
                <div class="result-val">${a.resultado}</div>
            `;
            listCont.appendChild(row);
        });
    }

    // INNOVACI√ìN: COMPARTIR
    function compartirLeaderboard() {
        const text = `üî• ¬°Mira el Leaderboard de La Ruta Garage! La competencia est√° que arde. üèÜ Consulta tu posici√≥n aqu√≠: ${window.location.href}`;
        if (navigator.share) {
            navigator.share({ title: 'Leaderboard La Ruta Garage', text: text, url: window.location.href });
        } else {
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`);
        }
    }

    window.onload = cargar;
</script>
</body>
</html>
