<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | La Ruta Garage</title>
    <link rel="icon" type="image/png" href="https://firebasestorage.googleapis.com/v0/b/d-clan-athletes.firebasestorage.app/o/La%20Ruta%20Garage%2FFavicon.png?alt=media&token=0e2d4383-2c9b-4005-9b46-943b40c0637d">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;600;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* ... (Tus estilos anteriores se mantienen) ... */
        :root { --neon: #d8ff5e; --bg: #050505; --glass: rgba(20, 20, 20, 0.7); }
        body { background: linear-gradient(rgba(0,0,0,0.8), rgba(0,0,0,0.8)), url('https://firebasestorage.googleapis.com/v0/b/d-clan-athletes.firebasestorage.app/o/La%20Ruta%20Garage%2FbglarutawebsiteBlack.jpg?alt=media&token=8e8d0ddb-b8a4-43f0-8199-98d31beaf078'); background-size: cover; background-position: center; background-attachment: fixed; color: white; font-family: 'Montserrat', sans-serif; padding: 10px; margin: 0; display: none; min-height: 100vh; }
        #modalEditar, #modalAgregarAHeat { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:2000; overflow-y:auto; padding:20px; box-sizing: border-box; }
        .modal-content { max-width:600px; margin:auto; background: var(--glass); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border: 1px solid rgba(216, 255, 94, 0.2); padding:30px; border-radius:20px; }
        .edit-grid { display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-top: 20px; }
        .edit-grid div { display: flex; flex-direction: column; }
        .edit-grid label { font-size: 0.65rem; color: var(--neon); text-transform: uppercase; margin-bottom: 5px; font-weight: 600; }
        .edit-grid input { background: rgba(0,0,0,0.5); border: 1px solid #333; color: white; padding: 12px; border-radius: 8px; font-size: 0.85rem; font-family: 'Montserrat'; }
        .header-admin { text-align: center; margin-bottom: 20px; padding-top: 20px; }
        .header-admin img { width: 120px; margin-bottom: 10px; filter: drop-shadow(0 0 10px rgba(216, 255, 94, 0.2)); }
        h1 { font-weight: 900; color: var(--neon); text-align: center; font-size: 1.4rem; margin: 0; letter-spacing: 2px; text-transform: uppercase; }
        .controls { max-width: 1200px; margin: 20px auto; display: flex; flex-wrap: wrap; gap: 10px; padding: 0 10px; }
        .search-box { flex: 1; min-width: 250px; }
        .search-box input { width: 100%; padding: 15px; background: var(--glass); backdrop-filter: blur(10px); border: 1px solid #333; color: white; border-radius: 12px; box-sizing: border-box; font-family: 'Montserrat'; }
        .filter-buttons { display: flex; gap: 8px; width: 100%; margin-bottom: 10px; }
        .btn-filter { flex: 1; padding: 14px; background: rgba(0,0,0,0.6); color: white; border: 1px solid #333; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 0.7rem; text-transform: uppercase; font-family: 'Montserrat'; transition: 0.3s; }
        .btn-filter.active { background: var(--neon); color: black; border-color: var(--neon); font-weight: 900; }
        .container { max-width: 1200px; margin: auto; background: var(--glass); backdrop-filter: blur(10px); border-radius: 15px; border: 1px solid rgba(255,255,255,0.05); overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.5); margin-bottom: 15px; }
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th { background: rgba(216, 255, 94, 0.05); color: var(--neon); text-align: left; padding: 12px 15px; font-size: 0.7rem; font-weight: 900; text-transform: uppercase; border-bottom: 2px solid var(--neon); }
        td { padding: 8px 15px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.8rem; font-weight: 300; }
        .pagination { display: flex; justify-content: center; align-items: center; gap: 15px; padding: 25px; }
        .btn-pag { background: #111; color: white; border: 1px solid #333; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-family: 'Montserrat'; font-weight: 600; font-size: 0.7rem; }
        .btn { padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.65rem; display: inline-flex; align-items: center; gap: 8px; transition: 0.3s; text-decoration: none; }
        .btn-view { background: rgba(255,255,255,0.05); color: #ccc; border-color: #333; }
        .btn-approve { background: var(--neon); color: black; font-weight: 900; }
        .btn-delete { background: transparent; color: #ff4444; border: 1px solid rgba(255,68,68,0.3); }
        .btn-wa { background: transparent; color: #25D366; border: 1px solid #25D366; }
        .btn:visited {color: inherit;}
        .btn:hover {opacity: 0.8;text-decoration: none;}
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 0.65rem; font-weight: 900; }
        .status-pendiente { border: 1px solid #ffaa00; color: #ffaa00; }
        .status-aprobado { border: 1px solid var(--neon); color: var(--neon); background: rgba(216, 255, 94, 0.1); }
        .heat-header { background: var(--neon); color: black; padding: 8px 15px; font-weight: 900; text-transform: uppercase; font-size: 0.8rem; display: flex; justify-content: space-between; align-items: center; }
        .atleta-chip { cursor: pointer; padding: 6px 12px; border: 1px solid #333; border-radius: 30px; font-size: 0.7rem; transition: 0.3s; background: rgba(255,255,255,0.05); }
        .atleta-chip.selected { border-color: var(--neon); color: var(--neon); background: rgba(216, 255, 94, 0.1); }
        .logistica-filters { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .logistica-filters select { background: #111; color: white; border: 1px solid #333; padding: 8px; border-radius: 8px; font-family: 'Montserrat'; font-size: 0.75rem; cursor: pointer; }

        @media (max-width: 800px) {
            #viewGeneral table thead { display: none; }
            #viewGeneral table tr { display: block; background: rgba(0,0,0,0.3); margin-bottom: 15px; border: 1px solid #222; padding: 15px; border-radius: 12px; }
            #viewGeneral table td { display: flex; justify-content: flex-end; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05); gap: 8px; flex-wrap: wrap; }
            #viewGeneral table td::before { content: attr(data-label); font-weight: 900; color: #666; text-transform: uppercase; font-size: 0.6rem; margin-right: auto; }
            #viewGeneral .btn { width: 100%; justify-content: center; }
            #viewLogistica table th { padding: 8px 5px; font-size: 0.55rem; }
            #viewLogistica table td { padding: 5px; font-size: 0.75rem; }
        }
    </style>
</head>
<body>

    <div id="modalAgregarAHeat">
        <div class="modal-content">
            <h2 style="font-weight:900; color:var(--neon); font-size:1.1rem; margin-bottom:15px; text-transform: uppercase; text-align: center;">Agregar Atleta al Heat</h2>
            <p style="font-size:0.7rem; color:#ccc; text-align:center; margin-bottom:20px;">Selecciona un atleta de la lista para añadirlo a este grupo.</p>
            <div id="listaDisponiblesParaHeat" style="display:flex; flex-wrap:wrap; gap:10px; max-height:300px; overflow-y:auto; padding:10px; background:rgba(0,0,0,0.3); border-radius:10px;"></div>
            <div style="margin-top:20px; display:flex; gap:12px;">
                <button onclick="document.getElementById('modalAgregarAHeat').style.display='none'" class="btn btn-view" style="flex:1; justify-content: center;">CERRAR</button>
            </div>
        </div>
    </div>

    <div id="modalEditar">
        <div class="modal-content">
            <h2 style="font-weight:900; color:var(--neon); font-size:1.1rem; margin:0; text-transform: uppercase; text-align: center;">Editar Atleta</h2>
            <div id="camposEditar" class="edit-grid"></div>
            <div style="margin-top:30px; display:flex; gap:12px;">
                <button id="btnGuardarEdit" class="btn btn-approve" style="flex:1;">GUARDAR CAMBIOS</button>
                <button onclick="document.getElementById('modalEditar').style.display='none'" class="btn btn-view" style="flex:1;">CANCELAR</button>
            </div>
        </div>
    </div>

    <div class="header-admin">
        <img src="https://firebasestorage.googleapis.com/v0/b/d-clan-athletes.firebasestorage.app/o/La%20Ruta%20Garage%2FLogo%20Icono%20Verde.png?alt=media&token=07ce2638-9667-4bad-8de1-c38abc5112f8" alt="Logo">
        <h1>Dashboard Administrativo</h1>
    </div>

    <div class="controls">
        <div class="filter-buttons">
            <button class="btn-filter active" id="tabGeneral" onclick="switchMainTab('general')">Atletas</button>
            <button class="btn-filter" id="tabLogistica" onclick="switchMainTab('logistica')">Heats / Logística</button>
        </div>
    </div>

    <div id="viewGeneral">
        <div class="controls">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Buscar por nombre, cédula o dorsal..." oninput="resetearYPaginacion()">
            </div>
            <div class="filter-buttons">
                <button class="btn-filter active" id="btnAll" onclick="filtrarModalidad('todos')">Todos</button>
                <button class="btn-filter" id="btnRace" onclick="filtrarModalidad('race')">Race</button>
                <button class="btn-filter" id="btnCF" onclick="filtrarModalidad('crossfit')">Crossfit</button>
            </div>
        </div>
        <div class="container">
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Dorsal</th>
                            <th>Atleta / Talla / Sexo</th>
                            <th>Modalidad / Cat</th>
                            <th>Pago Info</th>
                            <th>Multimedia</th>
                            <th>WhatsApp</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody id="tablaAtletas"></tbody>
                </table>
            </div>
            <div class="pagination">
                <button class="btn-pag" id="prevPage" onclick="cambiarPagina(-1)" disabled>Anterior</button>
                <span id="pageInfo" style="font-weight: 600; font-size: 0.8rem;">Página 1</span>
                <button class="btn-pag" id="nextPage" onclick="cambiarPagina(1)" disabled>Siguiente</button>
            </div>
        </div>
    </div>

    <div id="viewLogistica" style="display:none;">
        <div class="controls">
            <div class="filter-buttons">
                <button class="btn-filter active" id="btnHeatRace" onclick="switchHeatType('race')">Ruta Race (Auto)</button>
                <button class="btn-filter" id="btnHeatCF" onclick="switchHeatType('cf')">CrossFit (Manual)</button>
            </div>
        </div>
        <div id="containerHeatsRace"></div>
        <div id="containerHeatsCF" style="display:none;">
            <div class="container" style="padding: 20px;">
                <p style="font-size:0.8rem; color:var(--neon); font-weight:600; margin-bottom:15px; text-transform:uppercase;">1. Filtra y Selecciona Atletas:</p>
                <div class="logistica-filters">
                    <select id="filterSexoCF" onchange="renderizarSelectorCF()">
                        <option value="todos">Todos los Sexos</option>
                        <option value="Masculino">Masculino</option>
                        <option value="Femenino">Femenino</option>
                    </select>
                    <select id="filterCatCF" onchange="renderizarSelectorCF()">
                        <option value="todos">Todas las Categorías</option>
                        <option value="Escalado">Escalado</option>
                        <option value="Avanzado">Avanzado</option>
                    </select>
                </div>
                <div id="selectorAtletasCF" style="display:flex; flex-wrap:wrap; gap:10px; margin-bottom:20px;"></div>
                <button class="btn btn-approve" onclick="crearHeatManual()">Crear Heat con Seleccionados</button>
            </div>
            <div id="listaHeatsManuales"></div>
        </div>
    </div>

<script>
    // Variables de configuración
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyKOZQgueIrJ63Mfxp6Pz87dbVFgQmDgOjKcU990nOMqjuDphoM4UOvrKKkpbWQTwYp/exec";
    const SECRET_KEY = "RutaGarage2026";

    let todosLosAtletas = [];
    let atletasFiltrados = [];
    let paginaActual = 1;
    const registrosPorPagina = 20;
    let modalidadActual = 'todos';
    let atletaAEditar = null;
    let seleccionadosCF = [];
    let heatsCrossfitCreados = [];
    let heatActualIdParaAgregar = null; // Para saber a qué heat añadir

    (function validarAcceso() {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('key') === SECRET_KEY) {
            document.body.style.display = 'block';
            cargarAtletas();
        } else {
            window.location.href = "https://www.google.com";
        }
    })();

    function formatImgUrl(url) {
        if (!url || url === "") return "https://via.placeholder.com/150?text=No+Foto";
        let id = "";
        if (url.includes("id=")) {
            id = url.split("id=")[1].split("&")[0];
        } else if (url.includes("file/d/")) {
            id = url.split("file/d/")[1].split("/")[0];
        }
        if (id !== "") {
            return "https://lh3.googleusercontent.com/d/" + id;
        }
        return url;
    }

    async function cargarAtletas() {
        try {
            const response = await fetch(WEB_APP_URL + "?t=" + new Date().getTime());
            todosLosAtletas = await response.json();
            todosLosAtletas.reverse();
            aplicarFiltros();
            renderizarHeatsRace();
            renderizarSelectorCF();
        } catch (error) { console.error(error); }
    }

    // --- FUNCIONES DE LOGÍSTICA / HEATS ---

    function switchMainTab(tab) {
        document.getElementById('viewGeneral').style.display = tab === 'general' ? 'block' : 'none';
        document.getElementById('viewLogistica').style.display = tab === 'logistica' ? 'block' : 'none';
        document.getElementById('tabGeneral').classList.toggle('active', tab === 'general');
        document.getElementById('tabLogistica').classList.toggle('active', tab === 'logistica');
    }

    function switchHeatType(type) {
        document.getElementById('containerHeatsRace').style.display = type === 'race' ? 'block' : 'none';
        document.getElementById('containerHeatsCF').style.display = type === 'cf' ? 'block' : 'none';
        document.getElementById('btnHeatRace').classList.toggle('active', type === 'race');
        document.getElementById('btnHeatCF').classList.toggle('active', type === 'cf');
    }

    function renderizarHeatsRace() {
        const cont = document.getElementById('containerHeatsRace');
        cont.innerHTML = "";
        let raceAtletas = todosLosAtletas
            .filter(a => a.modalidad && a.modalidad.toLowerCase().includes('race') && a.estatus === 'Aprobado')
            .sort((a, b) => a.edad - b.edad);

        if (raceAtletas.length === 0) {
            cont.innerHTML = "<p style='text-align:center; padding:20px;'>No hay atletas aprobados en Ruta Race.</p>";
            return;
        }

        for (let i = 0; i < raceAtletas.length; i += 10) {
            let grupo = raceAtletas.slice(i, i + 10);
            let heatNum = Math.floor(i / 10) + 1;
            let div = document.createElement('div');
            div.className = "container";
            div.innerHTML = `
                <div class="heat-header">
                    <span>HEAT ${heatNum} (RUTA RACE)</span>
                    <span style="font-size:0.65rem; font-weight:300;">Edades: ${grupo[0].edad} - ${grupo[grupo.length-1].edad} años</span>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead><tr><th>Foto</th><th>Atleta</th><th>Dorsal</th><th>Edad</th></tr></thead>
                        <tbody>
                            ${grupo.map(a => `
                                <tr>
                                    <td><img src="${formatImgUrl(a.fotoCarnet)}" style="width:38px; height:38px; border-radius:50%; object-fit:cover; border:1px solid var(--neon);"></td>
                                    <td><strong>${a.nombre} ${a.apellido}</strong></td>
                                    <td><span class="badge status-aprobado">#${a.dorsal}</span></td>
                                    <td>${a.edad} años</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>`;
            cont.appendChild(div);
        }
    }

    function renderizarSelectorCF() {
        const sel = document.getElementById('selectorAtletasCF');
        const sFiltro = document.getElementById('filterSexoCF').value;
        const cFiltro = document.getElementById('filterCatCF').value;
        
        sel.innerHTML = "";
        let ocupados = heatsCrossfitCreados.flatMap(h => h.atletas.map(at => at.fila));
        
        let cfAtletas = todosLosAtletas.filter(a => {
            const esCF = a.modalidad && a.modalidad.toLowerCase().includes('crossfit');
            const estaAprobado = a.estatus === 'Aprobado';
            const estaLibre = !ocupados.includes(a.fila);
            const cumpleSexo = sFiltro === 'todos' || (a.sexo && a.sexo === sFiltro);
            const cumpleCat = cFiltro === 'todos' || (a.categoria && a.categoria.includes(cFiltro));
            return esCF && estaAprobado && estaLibre && cumpleSexo && cumpleCat;
        });

        if(cfAtletas.length === 0) {
            sel.innerHTML = "<p style='font-size:0.7rem; color:#666;'>No hay atletas disponibles con estos filtros.</p>";
            return;
        }

        cfAtletas.forEach(a => {
            let chip = document.createElement('div');
            chip.className = "atleta-chip" + (seleccionadosCF.includes(a.fila) ? " selected" : "");
            chip.innerText = `${a.nombre} (${a.sexo ? a.sexo[0] : '?'}) - ${a.categoria}`;
            chip.onclick = () => {
                chip.classList.toggle('selected');
                if(seleccionadosCF.includes(a.fila)) seleccionadosCF = seleccionadosCF.filter(f => f !== a.fila);
                else seleccionadosCF.push(a.fila);
            };
            sel.appendChild(chip);
        });
    }

    function crearHeatManual() {
        if (seleccionadosCF.length === 0) return alert("Selecciona atletas primero.");
        let nuevosAtletas = todosLosAtletas.filter(a => seleccionadosCF.includes(a.fila));
        heatsCrossfitCreados.push({ id: Date.now(), atletas: nuevosAtletas });
        seleccionadosCF = [];
        actualizarVistaHeatsCF();
    }

    // --- NUEVA FUNCIÓN: ABRIR SELECTOR PARA AGREGAR A HEAT EXISTENTE ---
    function abrirSelectorParaAgregar(heatId) {
        heatActualIdParaAgregar = heatId;
        const cont = document.getElementById('listaDisponiblesParaHeat');
        cont.innerHTML = "";
        
        // Atletas que ya están en algún Heat
        let ocupados = heatsCrossfitCreados.flatMap(h => h.atletas.map(at => at.fila));
        
        // Atletas de CF Aprobados que NO están en ningún Heat
        let disponibles = todosLosAtletas.filter(a => 
            a.modalidad && a.modalidad.toLowerCase().includes('crossfit') && 
            a.estatus === 'Aprobado' && !ocupados.includes(a.fila)
        );

        if(disponibles.length === 0) {
            cont.innerHTML = "<p style='font-size:0.8rem; color:#ff4444; width:100%; text-align:center;'>No hay más atletas libres.</p>";
        } else {
            disponibles.forEach(a => {
                let chip = document.createElement('div');
                chip.className = "atleta-chip";
                chip.style.borderColor = "rgba(255,255,255,0.2)";
                chip.innerText = `${a.nombre} (${a.sexo ? a.sexo[0] : '?'}) - ${a.categoria}`;
                chip.onclick = () => agregarAtletaAHeat(a.fila);
                cont.appendChild(chip);
            });
        }
        document.getElementById('modalAgregarAHeat').style.display = 'block';
    }

    function agregarAtletaAHeat(filaAtleta) {
        let atleta = todosLosAtletas.find(a => a.fila === filaAtleta);
        let heat = heatsCrossfitCreados.find(h => h.id === heatActualIdParaAgregar);
        
        if(atleta && heat) {
            heat.atletas.push(atleta);
            document.getElementById('modalAgregarAHeat').style.display = 'none';
            actualizarVistaHeatsCF();
        }
    }

    function borrarHeatCF(id) {
        if(!confirm("¿Borrar este Heat completo?")) return;
        heatsCrossfitCreados = heatsCrossfitCreados.filter(h => h.id !== id);
        actualizarVistaHeatsCF();
    }

    function quitarAtletaDeHeatCF(heatId, fila) {
        let heat = heatsCrossfitCreados.find(h => h.id === heatId);
        heat.atletas = heat.atletas.filter(a => a.fila !== fila);
        if(heat.atletas.length === 0) heatsCrossfitCreados = heatsCrossfitCreados.filter(h => h.id !== heatId);
        actualizarVistaHeatsCF();
    }

    function actualizarVistaHeatsCF() {
        const cont = document.getElementById('listaHeatsManuales');
        cont.innerHTML = "";
        heatsCrossfitCreados.forEach((heat, idx) => {
            let div = document.createElement('div');
            div.className = "container";
            div.innerHTML = `
                <div class="heat-header" style="background:#fff;">
                    <span>HEAT ${idx + 1} (CROSSFIT)</span>
                    <div style="display:flex; gap:10px;">
                        <button class="btn btn-approve" onclick="abrirSelectorParaAgregar(${heat.id})" style="padding:5px 10px; font-size:0.6rem;"><i class="fas fa-user-plus"></i> AGREGAR</button>
                        <button class="btn-delete" onclick="borrarHeatCF(${heat.id})" style="background:white; border:none; padding:5px 10px; cursor:pointer;"><i class="fas fa-trash"></i> ELIMINAR HEAT</button>
                    </div>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead><tr><th>Foto</th><th>Atleta</th><th>Sexo/Cat</th><th>Acción</th></tr></thead>
                        <tbody>
                            ${heat.atletas.map(a => `
                                <tr>
                                    <td><img src="${formatImgUrl(a.fotoCarnet)}" style="width:38px; height:38px; border-radius:50%; object-fit:cover; border:1px solid #333;"></td>
                                    <td><strong>${a.nombre} ${a.apellido}</strong></td>
                                    <td>${a.sexo || ''} / ${a.categoria}</td>
                                    <td><button class="btn-delete" onclick="quitarAtletaDeHeatCF(${heat.id}, ${a.fila})" style="padding:4px 8px;">Quitar</button></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>`;
            cont.prepend(div);
        });
        renderizarSelectorCF();
    }

    // --- RESTO DE FUNCIONES (GENERAL, EDICIÓN, ETC) SE MANTIENEN IGUAL ---

    function filtrarModalidad(mod) {
        modalidadActual = mod.toLowerCase(); 
        document.querySelectorAll('#viewGeneral .btn-filter').forEach(b => b.classList.remove('active'));
        const btnId = mod === 'todos' ? 'btnAll' : mod === 'race' ? 'btnRace' : 'btnCF';
        document.getElementById(btnId).classList.add('active');
        resetearYPaginacion();
    }

    function aplicarFiltros() {
        const busqueda = document.getElementById('searchInput').value.toLowerCase();
        atletasFiltrados = todosLosAtletas.filter(atleta => {
            const cumpleMod = (modalidadActual === 'todos' || (atleta.modalidad && atleta.modalidad.toLowerCase().includes(modalidadActual)));
            const dataStr = [atleta.nombre, atleta.apellido, atleta.cedula, atleta.referencia, atleta.dorsal].join(' ').toLowerCase();
            return cumpleMod && dataStr.includes(busqueda);
        });
        renderizarTabla();
    }

    function renderizarTabla() {
        const tabla = document.getElementById('tablaAtletas');
        const inicio = (paginaActual - 1) * registrosPorPagina;
        const atletasPagina = atletasFiltrados.slice(inicio, inicio + registrosPorPagina);
        tabla.innerHTML = "";
        atletasPagina.forEach((atleta, index) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td data-label="Dorsal"><span class="badge ${atleta.estatus === 'Pendiente' ? 'status-pendiente' : 'status-aprobado'}">${atleta.dorsal || 'PEND'}</span></td>
                <td data-label="Atleta">
                    <strong>${atleta.nombre} ${atleta.apellido || ''}</strong><br>
                    <small style="color:var(--neon); font-weight:600">Talla: ${atleta.talla || 'S/N'}</small><br>
                    <small style="color:#aaa;">Sexo: ${atleta.sexo || 'S/D'}</small>
                </td>
                <td data-label="Modalidad">${atleta.modalidad}<br><small style="color:#aaa;">Cat: ${atleta.categoria || 'S/C'}</small></td>
                <td data-label="Pago Info"><strong>${atleta.metodo || 'S/M'}</strong><br><small style="color:#777">Ref: ${atleta.referencia}</small></td>
                <td data-label="Multimedia">
                    <a href="${atleta.fotoCarnet}" target="_blank" class="btn btn-view"><i class="fas fa-id-card"></i> FOTO</a>
                    <a href="${atleta.fotoPago}" target="_blank" class="btn btn-view"><i class="fas fa-receipt"></i> PAGO</a>
                </td>
                <td data-label="WhatsApp"><a href="https://wa.me/${String(atleta.whatsapp || atleta.telefono).replace(/\D/g,'')}" target="_blank" class="btn btn-wa"><i class="fab fa-whatsapp"></i> CHAT</a></td>
                <td data-label="Acción">
                    <button class="btn btn-view" onclick='prepararEdicion(${inicio + index})'><i class="fas fa-edit"></i></button>
                    <button class="btn btn-delete" onclick="eliminarAtleta(${atleta.fila}, '${atleta.nombre}')"><i class="fas fa-trash"></i></button>
                    ${atleta.estatus === 'Pendiente' ? `<button class="btn btn-approve" onclick="procesarAprobacion(${atleta.fila},'${atleta.correo}','${atleta.nombre}')">APROBAR</button>` : ''}
                </td>`;
            tabla.appendChild(tr);
        });
        actualizarControlesPagina(atletasFiltrados.length);
    }

    function prepararEdicion(idx) {
        atletaAEditar = atletasFiltrados[idx];
        const contenedor = document.getElementById('camposEditar');
        contenedor.innerHTML = "";
        const campos = [
            {id: "nombre", label: "Nombre", valor: atletaAEditar.nombre}, {id: "apellido", label: "Apellido", valor: atletaAEditar.apellido},
            {id: "cedula", label: "Cédula", valor: atletaAEditar.cedula}, {id: "telefono", label: "Teléfono", valor: atletaAEditar.telefono},
            {id: "correo", label: "Correo", valor: atletaAEditar.correo}, {id: "talla", label: "Talla", valor: atletaAEditar.talla},
            {id: "sexo", label: "Sexo", valor: atletaAEditar.sexo}, {id: "modalidad", label: "Modalidad", valor: atletaAEditar.modalidad}, 
            {id: "categoria", label: "Categoría", valor: atletaAEditar.categoria},
            {id: "dorsal", label: "Dorsal", valor: atletaAEditar.dorsal}, {id: "fecha", label: "Fecha Registro", valor: atletaAEditar.fecha}
        ];
        campos.forEach(c => {
            contenedor.innerHTML += `<div><label>${c.label}</label><input type="text" id="edit_${c.id}" value="${c.valor || ''}"></div>`;
        });
        document.getElementById('modalEditar').style.display = 'block';
        document.getElementById('btnGuardarEdit').onclick = guardarEdicion;
    }

    async function guardarEdicion() {
        const payload = {
            accion: "editar", fila: atletaAEditar.fila,
            nombre: document.getElementById('edit_nombre').value, apellido: document.getElementById('edit_apellido').value,
            cedula: document.getElementById('edit_cedula').value, telefono: document.getElementById('edit_telefono').value,
            correo: document.getElementById('edit_correo').value, talla: document.getElementById('edit_talla').value,
            sexo: document.getElementById('edit_sexo').value,
            modalidad: document.getElementById('edit_modalidad').value, categoria: document.getElementById('edit_categoria').value,
            dorsal: document.getElementById('edit_dorsal').value, fecha: document.getElementById('edit_fecha').value
        };
        if(!confirm("¿Guardar cambios?")) return;
        await fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
        document.getElementById('modalEditar').style.display = 'none';
        cargarAtletas();
    }

    async function eliminarAtleta(fila, n) {
        if(!confirm(`¿Eliminar a ${n}?`)) return;
        await fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ accion: "eliminar", fila: fila }) });
        cargarAtletas();
    }

    function actualizarControlesPagina(t) {
        const totalPaginas = Math.ceil(t / registrosPorPagina);
        document.getElementById('pageInfo').innerText = `Página ${paginaActual} de ${totalPaginas || 1}`;
        document.getElementById('prevPage').disabled = paginaActual === 1;
        document.getElementById('nextPage').disabled = paginaActual >= totalPaginas;
    }

    function cambiarPagina(d) { paginaActual += d; renderizarTabla(); window.scrollTo(0,0); }
    function resetearYPaginacion() { paginaActual = 1; aplicarFiltros(); }

    async function procesarAprobacion(f, c, n) {
        if(!confirm(`¿Aprobar a ${n}?`)) return;
        await fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ accion: "aprobar", fila: f, correo: c, nombre: n }) });
        cargarAtletas();
    }
</script>
</body>
</html>
