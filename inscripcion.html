<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inscripción | La Ruta Garage</title>
    <link href="https://fonts.googleapis.com/css2?family=Syncopate:wght@700&family=Montserrat:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --neon: #39FF14; --bg: #050505; --card: #111; }
        body { background: var(--bg); color: white; font-family: 'Montserrat', sans-serif; margin: 0; padding: 20px; }
        
        .header-registro { text-align: center; margin-bottom: 30px; }
        .header-registro img { width: 120px; margin-bottom: 10px; }
        .header-registro h1 { font-family: 'Syncopate'; color: var(--neon); font-size: 1.2rem; margin: 0; letter-spacing: 4px; }
        .header-registro p { font-size: 0.8rem; opacity: 0.7; text-transform: uppercase; letter-spacing: 2px; }

        .form-container { max-width: 800px; margin: 0 auto; background: var(--card); border: 1px solid #222; border-radius: 15px; padding: 40px; box-shadow: 0 0 30px rgba(0,0,0,0.5); }
        h2 { font-family: 'Syncopate'; color: var(--neon); text-align: center; letter-spacing: 2px; margin-bottom: 30px; border-bottom: 1px solid var(--neon); padding-bottom: 10px; font-size: 1rem; }
        
        .section-label { color: var(--neon); font-size: 0.75rem; font-weight: bold; text-transform: uppercase; margin: 30px 0 15px; display: block; letter-spacing: 2px; border-left: 3px solid var(--neon); padding-left: 10px; }
        
        .grid-form { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .full-width { grid-column: span 2; }
        
        label { display: block; font-size: 0.65rem; color: #888; text-transform: uppercase; margin-bottom: 5px; }
        input, select { width: 100%; padding: 10px; background: #000; border: 1px solid #333; color: white; border-radius: 5px; box-sizing: border-box; font-family: 'Montserrat'; font-size: 0.85rem; }
        input:focus { border-color: var(--neon); outline: none; }

        .foto-guia { background: #1a1a1a; border: 1px dashed var(--neon); padding: 15px; border-radius: 8px; margin-bottom: 10px; display: flex; align-items: center; gap: 15px; }
        .foto-ejemplo { width: 60px; height: 60px; background: #333; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: #555; }
        .foto-instruccion { font-size: 0.7rem; color: #aaa; line-height: 1.4; }

        .pago-box { background: #1a1a1a; padding: 20px; border-radius: 10px; margin-top: 15px; border: 1px solid #333; }
        .price-tag { font-family: 'Syncopate'; font-size: 1.1rem; color: #fff; margin-bottom: 5px; display: block; }
        
        #instruccionesPago { background: #000; padding: 15px; border-radius: 5px; font-size: 0.8rem; margin-top: 15px; border-left: 3px solid var(--neon); line-height: 1.6; display: none; }

        .btn-submit { width: 100%; padding: 18px; background: var(--neon); color: black; border: none; font-weight: 900; font-family: 'Syncopate'; cursor: pointer; margin-top: 30px; transition: 0.3s; clip-path: polygon(3% 0%, 100% 0%, 97% 100%, 0% 100%); }
        .btn-submit:hover { transform: scale(1.02); background: white; }

        .help-container { position: fixed; bottom: 20px; right: 20px; display: flex; align-items: center; gap: 10px; z-index: 100; text-decoration: none; }
        .help-msg { background: white; color: black; padding: 8px 15px; border-radius: 20px; font-size: 0.7rem; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.3); white-space: nowrap; }
        .btn-help { background: #25D366; color: white; width: 55px; height: 55px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; box-shadow: 0 4px 15px rgba(0,0,0,0.3); transition: 0.3s; }

        @media (max-width: 600px) { .grid-form { grid-template-columns: 1fr; } .full-width { grid-column: span 1; } .help-msg { display: none; } }
    </style>
</head>
<body>

<a href="https://wa.me/584121234567?text=Hola!%20Tengo%20un%20problema%20con%20el%20formulario%20de%20inscripción" class="help-container" target="_blank">
    <div class="help-msg">¿Tienes algún inconveniente? ¡Escríbenos!</div>
    <div class="btn-help"><i class="fab fa-whatsapp"></i></div>
</a>

<div class="header-registro">
    <img src="https://i.ibb.co/mF8DTRrm/Logo-Icono-Verde.png" alt="Logo">
    <h1>LA RUTA GARAGE</h1>
    <p>¿Estás listo para adentrarte a nuestra aventura?</p>
</div>

<div class="form-container">
    <h2>REGISTRO DE ATLETA</h2>
    
    <form id="registroForm">
        <span class="section-label">1. Datos Personales</span>
        <div class="grid-form">
            <div><label>Nombre</label><input type="text" id="nombre" required></div>
            <div><label>Apellido</label><input type="text" id="apellido" required></div>
            <div><label>Cédula</label><input type="number" id="cedula" required></div>
            <div><label>Fecha de Nacimiento</label><input type="date" id="fechaNac" required></div>
            <div><label>Sexo</label><select id="sexo"><option value="Masculino">Masculino</option><option value="Femenino">Femenino</option></select></div>
            <div><label>Ciudad</label><input type="text" id="ciudad" required></div>
            <div><label>WhatsApp (Ej: 04121234567)</label><input type="tel" id="telefono" maxlength="11" placeholder="04121234567" required></div>
            <div><label>Correo Electrónico</label><input type="email" id="correo" required></div>
            <div class="full-width"><label>Centro de Entrenamiento / Box</label><input type="text" id="box"></div>
            
            <div class="full-width">
                <label>Foto Tipo Carnet</label>
                <div class="foto-guia">
                    <div class="foto-ejemplo"><i class="fas fa-user"></i></div>
                    <div class="foto-instruccion">
                        Fondo unicolor, rostro despejado.<br>
                        <strong>Máximo 1MB (Usa una captura de pantalla si pesa mucho).</strong>
                    </div>
                </div>
                <input type="file" id="fotoCarnet" accept="image/*" required>
            </div>
        </div>

        <span class="section-label">2. Modalidad</span>
        <div class="grid-form">
            <div>
                <label>Modalidad</label>
                <select id="modalidad" onchange="ajustarCategorias()">
                    <option value="Ruta Race">Ruta Race ($25)</option>
                    <option value="Ruta CrossFit">Ruta CrossFit ($30)</option>
                </select>
            </div>
            <div><label>Categoría</label><select id="categoria"></select></div>
        </div>

        <span class="section-label">3. Pago</span>
        <div class="pago-box">
            <span id="labelPrecio" class="price-tag">TOTAL: $25</span>
            <span id="tasaDisplay" style="color:var(--neon); font-size: 0.7rem;">Cargando tasa oficial...</span>

            <div class="grid-form" style="margin-top: 15px;">
                <div class="full-width">
                    <label>Método de Pago</label>
                    <select id="metodoPago" onchange="mostrarInstrucciones()" required>
                        <option value="">Seleccione...</option>
                        <option value="Pago Móvil">Pago Móvil (Bolívares)</option>
                        <option value="Zelle">Zelle (Dólares)</option>
                    </select>
                </div>
                
                <div id="instruccionesPago" class="full-width"></div>

                <div><label>Monto a pagar</label><input type="text" id="montoBs" readonly></div>
                <div><label>Referencia Bancaria</label><input type="text" id="referencia" required></div>
                <div class="full-width">
                    <label>Adjuntar Comprobante</label>
                    <input type="file" id="fotoPago" accept="image/*" required>
                </div>
            </div>
        </div>

        <button type="submit" id="btnEnviar" class="btn-submit">ENVIAR INSCRIPCIÓN</button>
    </form>
    <div id="mensajeFinal" style="display:none; text-align:center; padding:20px;">
        <h3 style="color:var(--neon)">¡REGISTRO ENVIADO!</h3>
        <p>Tu inscripción está siendo procesada. Revisa tu correo.</p>
    </div>
</div>

<script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyKOZQgueIrJ63Mfxp6Pz87dbVFgQmDgOjKcU990nOMqjuDphoM4UOvrKKkpbWQTwYp/exec"; 
    let TASA_BCV = 0;
    let inscritos = [];

    async function inicializar() {
        try {
            // Cargamos tasa y lista de inscritos al mismo tiempo
            const [respTasa, respInscritos] = await Promise.all([
                fetch(WEB_APP_URL + "?getTasa=true"),
                fetch(WEB_APP_URL)
            ]);
            
            const dataTasa = await respTasa.json();
            TASA_BCV = dataTasa.tasa;
            document.getElementById('tasaDisplay').innerText = "Tasa Oficial BCV: " + TASA_BCV.toFixed(2) + " Bs.";
            
            inscritos = await respInscritos.json();
            ajustarCategorias();
        } catch (e) { console.error("Error inicializando"); }
    }

    function ajustarCategorias() {
        const mod = document.getElementById('modalidad').value;
        const cat = document.getElementById('categoria');
        const precioUSD = (mod === "Ruta Race") ? 25 : 30;
        cat.innerHTML = mod === "Ruta Race" ? '<option>General</option>' : '<option>Escalado</option><option>Avanzado</option>';
        document.getElementById('labelPrecio').innerText = "TOTAL: $" + precioUSD;
        if(TASA_BCV > 0) document.getElementById('montoBs').value = (precioUSD * TASA_BCV).toFixed(2) + " Bs.";
    }

    function mostrarInstrucciones() {
        const metodo = document.getElementById('metodoPago').value;
        const div = document.getElementById('instruccionesPago');
        div.style.display = metodo ? "block" : "none";
        if(metodo === "Pago Móvil") {
            div.innerHTML = `<strong>DATOS PAGO MÓVIL:</strong><br>Banco: Mercantil (0105)<br>Teléfono: 04121234567<br>Cédula: V-12345678`;
        } else if(metodo === "Zelle") {
            div.innerHTML = `<strong>DATOS ZELLE:</strong><br>Correo: pagos@larutagarage.com<br>Titular: La Ruta Garage LLC`;
        }
    }

    async function processFile(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
        });
    }

    document.getElementById('registroForm').onsubmit = async (e) => {
        e.preventDefault();
        const btn = document.getElementById('btnEnviar');
        const cedulaInput = document.getElementById('cedula').value;
        const refInput = document.getElementById('referencia').value;

        // VERIFICACIÓN DE DUPLICADOS CON ALERTA
        const duplicado = inscritos.find(a => a.referencia == refInput);
        
        if(duplicado) {
            alert("⚠️ Error: Este número de referencia ya ha sido registrado.");
            return; // Detiene el envío
        }

        btn.disabled = true;
        btn.innerText = "ENVIANDO...";

        try {
            const data = {
                nombre: document.getElementById('nombre').value,
                apellido: document.getElementById('apellido').value,
                cedula: cedulaInput,
                fechaNac: document.getElementById('fechaNac').value,
                sexo: document.getElementById('sexo').value,
                ciudad: document.getElementById('ciudad').value,
                telefono: document.getElementById('telefono').value,
                correo: document.getElementById('correo').value,
                modalidad: document.getElementById('modalidad').value,
                categoria: document.getElementById('categoria').value,
                referencia: refInput,
                montoBs: document.getElementById('montoBs').value,
                fotoCarnet: await processFile(document.getElementById('fotoCarnet').files[0]),
                fotoPago: await processFile(document.getElementById('fotoPago').files[0])
            };

            await fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) });
            document.getElementById('registroForm').style.display = 'none';
            document.getElementById('mensajeFinal').style.display = 'block';
            window.scrollTo(0,0);
        } catch (error) {
            alert("Ocurrió un error. Revisa tu internet.");
            btn.disabled = false;
            btn.innerText = "ENVIAR INSCRIPCIÓN";
        }
    };

    window.onload = inicializar;
</script>
</body>
</html>
