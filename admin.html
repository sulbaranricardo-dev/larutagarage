<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | La Ruta Garage</title>
    <link href="https://fonts.googleapis.com/css2?family=Syncopate:wght@700&family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --neon: #39FF14; --bg: #050505; }
        body { background: var(--bg); color: white; font-family: 'Montserrat', sans-serif; padding: 10px; margin: 0; display: none; } /* Oculto hasta validar KEY */
        
        #modalEditar { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:2000; overflow-y:auto; padding:20px; box-sizing: border-box; }
        .modal-content { max-width:600px; margin:auto; background:#111; border:1px solid var(--neon); padding:25px; border-radius:15px; }
        .edit-grid { display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-top: 20px; }
        .edit-grid div { display: flex; flex-direction: column; }
        .edit-grid label { font-size: 0.6rem; color: #666; text-transform: uppercase; margin-bottom: 5px; }
        .edit-grid input { background: #000; border: 1px solid #333; color: white; padding: 10px; border-radius: 5px; font-size: 0.8rem; }

        .header-admin { text-align: center; margin-bottom: 10px; }
        .header-admin img { width: 130px; margin-bottom: 5px; }
        h1 { font-family: 'Syncopate'; color: var(--neon); text-align: center; font-size: 0.9rem; margin: 10px 0; letter-spacing: 3px; }

        .controls { max-width: 1200px; margin: 10px auto; display: flex; flex-wrap: wrap; gap: 10px; padding: 0 10px; }
        .search-box { flex: 1; min-width: 250px; }
        .search-box input { width: 100%; padding: 12px 15px; background: #111; border: 1px solid #333; color: white; border-radius: 8px; box-sizing: border-box; }
        
        .filter-buttons { display: flex; gap: 5px; width: 100%; }
        .btn-filter { flex: 1; padding: 12px; background: #111; color: white; border: 1px solid #333; border-radius: 8px; cursor: pointer; font-family: 'Syncopate'; font-size: 0.6rem; }
        .btn-filter.active { background: var(--neon); color: black; border-color: var(--neon); }

        .container { max-width: 1200px; margin: auto; background: #111; border-radius: 10px; border: 1px solid #222; overflow: hidden; }
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #1a1a1a; color: var(--neon); text-align: left; padding: 15px; font-size: 0.7rem; border-bottom: 2px solid var(--neon); }
        td { padding: 15px; border-bottom: 1px solid #222; font-size: 0.8rem; }

        .pagination { display: flex; justify-content: center; align-items: center; gap: 15px; padding: 20px; }
        .btn-pag { background: #222; color: white; border: 1px solid #444; padding: 8px 15px; border-radius: 5px; cursor: pointer; }
        
        .btn { padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 0.65rem; display: inline-flex; align-items: center; gap: 8px; text-decoration: none; border: 1px solid transparent; }
        .btn-view { background: #1a1a1a; color: #ccc; border-color: #333; }
        .btn-approve { background: var(--neon); color: black; }
        .btn-wa { background: #000; color: #25D366; border-color: #25D366; }
        .btn-delete { background: #1a1a1a; color: #ff4444; border-color: #333; }
        
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.65rem; font-weight: bold; }
        .status-pendiente { border: 1px solid #ffaa00; color: #ffaa00; background: transparent; }
        .status-aprobado { border: 1px solid var(--neon); color: var(--neon); background: #000; }

        @media (max-width: 800px) {
            table thead { display: none; }
            table tr { display: block; background: #111; margin-bottom: 15px; border: 1px solid #222; padding: 10px; border-radius: 8px; }
            table td { display: flex; justify-content: flex-end; align-items: center; padding: 12px 10px; border-bottom: 1px solid #1a1a1a; gap: 5px; flex-wrap: wrap; }
            table td::before { content: attr(data-label); font-weight: bold; color: #666; text-transform: uppercase; font-size: 0.6rem; margin-right: auto; }
            .btn { width: 100%; font-size: 0.75rem; padding: 12px; margin-top: 5px; }
            .edit-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div id="modalEditar">
        <div class="modal-content">
            <h2 style="font-family:'Syncopate'; color:var(--neon); font-size:0.8rem; margin:0;">EDITAR ATLETA</h2>
            <div id="camposEditar" class="edit-grid"></div>
            <div style="margin-top:25px; display:flex; gap:10px;">
                <button id="btnGuardarEdit" class="btn btn-approve" style="flex:1;">GUARDAR</button>
                <button onclick="document.getElementById('modalEditar').style.display='none'" class="btn btn-view" style="flex:1;">CANCELAR</button>
            </div>
        </div>
    </div>

    <div class="header-admin">
        <img src="https://i.ibb.co/mF8DTRrm/Logo-Icono-Verde.png" alt="Logo">
        <h1>PANEL ADMINISTRATIVO</h1>
    </div>

    <div class="controls">
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="Nombre, cédula, dorsal..." oninput="resetearYPaginacion()">
        </div>
        <div class="filter-buttons">
            <button class="btn-filter active" id="btnAll" onclick="filtrarModalidad('todos')">TODOS</button>
            <button class="btn-filter" id="btnRace" onclick="filtrarModalidad('race')">RACE</button>
            <button class="btn-filter" id="btnCF" onclick="filtrarModalidad('crossfit')">CROSSFIT</button>
        </div>
    </div>

    <div class="container">
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>Dorsal</th>
                        <th>Atleta / Talla</th>
                        <th>Modalidad</th>
                        <th>Pago Info</th>
                        <th>Multimedia</th>
                        <th>WhatsApp</th>
                        <th>Acción</th>
                    </tr>
                </thead>
                <tbody id="tablaAtletas"></tbody>
            </table>
        </div>
        <div class="pagination">
            <button class="btn-pag" id="prevPage" onclick="cambiarPagina(-1)" disabled>Anterior</button>
            <span id="pageInfo">Página 1</span>
            <button class="btn-pag" id="nextPage" onclick="cambiarPagina(1)" disabled>Siguiente</button>
        </div>
    </div>

<script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyKOZQgueIrJ63Mfxp6Pz87dbVFgQmDgOjKcU990nOMqjuDphoM4UOvrKKkpbWQTwYp/exec";
    const SECRET_KEY = "RutaGarage2026"; // TU LLAVE SECRETA

    let todosLosAtletas = [];
    let atletasFiltrados = [];
    let paginaActual = 1;
    const registrosPorPagina = 20;
    let modalidadActual = 'todos';
    let atletaAEditar = null;

    // VALIDACIÓN DE URL SECRETA
    (function validarAcceso() {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('key') === SECRET_KEY) {
            document.body.style.display = 'block';
            cargarAtletas();
        } else {
            window.location.href = "https://www.google.com";
        }
    })();

    async function cargarAtletas() {
        try {
            const response = await fetch(WEB_APP_URL + "?t=" + new Date().getTime());
            todosLosAtletas = await response.json();
            todosLosAtletas.reverse();
            aplicarFiltros();
        } catch (error) { console.error(error); }
    }

    function filtrarModalidad(mod) {
        modalidadActual = mod.toLowerCase(); 
        document.querySelectorAll('.btn-filter').forEach(b => b.classList.remove('active'));
        document.getElementById(mod === 'todos' ? 'btnAll' : mod === 'race' ? 'btnRace' : 'btnCF').classList.add('active');
        resetearYPaginacion();
    }

    function aplicarFiltros() {
        const busqueda = document.getElementById('searchInput').value.toLowerCase();
        atletasFiltrados = todosLosAtletas.filter(atleta => {
            const cumpleMod = (modalidadActual === 'todos' || atleta.modalidad.toLowerCase().includes(modalidadActual));
            const dataStr = [atleta.nombre, atleta.cedula, atleta.referencia, atleta.dorsal].join(' ').toLowerCase();
            return cumpleMod && dataStr.includes(busqueda);
        });
        renderizarTabla();
    }

    function renderizarTabla() {
        const tabla = document.getElementById('tablaAtletas');
        const inicio = (paginaActual - 1) * registrosPorPagina;
        const atletasPagina = atletasFiltrados.slice(inicio, inicio + registrosPorPagina);
        
        tabla.innerHTML = "";
        atletasPagina.forEach((atleta, index) => {
            const tr = document.createElement('tr');
            // Usamos un índice para referenciar al atleta de forma segura
            tr.innerHTML = `
                <td data-label="Dorsal"><span class="badge ${atleta.estatus === 'Pendiente' ? 'status-pendiente' : 'status-aprobado'}">${atleta.dorsal || 'PEND'}</span></td>
                <td data-label="Atleta"><strong>${atleta.nombre} ${atleta.apellido || ''}</strong><br><small style="color:var(--neon)">Talla: ${atleta.talla || 'S/N'}</small></td>
                <td data-label="Modalidad"><small>${atleta.modalidad}</small></td>
                <td data-label="Pago"><small><strong>${atleta.metodo || 'S/M'}</strong></small><br><small style="color:#888">Ref: ${atleta.referencia}</small></td>
                <td data-label="Multimedia">
                    <a href="${atleta.fotoCarnet}" target="_blank" class="btn btn-view"><i class="fas fa-id-card"></i></a>
                    <a href="${atleta.fotoPago}" target="_blank" class="btn btn-view"><i class="fas fa-receipt"></i></a>
                </td>
                <td data-label="WhatsApp"><a href="https://wa.me/${String(atleta.whatsapp || atleta.telefono).replace(/\D/g,'')}" target="_blank" class="btn btn-wa"><i class="fab fa-whatsapp"></i></a></td>
                <td data-label="Acción">
                    <button class="btn btn-view" onclick='prepararEdicion(${inicio + index})'><i class="fas fa-edit"></i></button>
                    <button class="btn btn-delete" onclick="eliminarAtleta(${atleta.fila}, '${atleta.nombre}')"><i class="fas fa-trash"></i></button>
                    ${atleta.estatus === 'Pendiente' ? `<button class="btn btn-approve" onclick="procesarAprobacion(${atleta.fila},'${atleta.correo}','${atleta.nombre}')">APROBAR</button>` : ''}
                </td>`;
            tabla.appendChild(tr);
        });
        actualizarControlesPagina(atletasFiltrados.length);
    }

    // Nueva función para abrir el editor cargando los datos correctamente
    function prepararEdicion(indexEnFiltrados) {
        atletaAEditar = atletasFiltrados[indexEnFiltrados];
        const contenedor = document.getElementById('camposEditar');
        contenedor.innerHTML = "";

        // Definimos los campos y les asignamos el valor que viene de Google Sheets
        const campos = [
            {id: "nombre", label: "Nombre", valor: atletaAEditar.nombre},
            {id: "apellido", label: "Apellido", valor: atletaAEditar.apellido},
            {id: "cedula", label: "Cédula", valor: atletaAEditar.cedula},
            {id: "telefono", label: "Teléfono", valor: atletaAEditar.telefono || atletaAEditar.whatsapp},
            {id: "correo", label: "Correo", valor: atletaAEditar.correo},
            {id: "talla", label: "Talla", valor: atletaAEditar.talla},
            {id: "modalidad", label: "Modalidad", valor: atletaAEditar.modalidad},
            {id: "categoria", label: "Categoría", valor: atletaAEditar.categoria},
            {id: "dorsal", label: "Dorsal", valor: atletaAEditar.dorsal},
            {id: "fecha", label: "Fecha Registro", valor: atletaAEditar.fecha}
        ];

        campos.forEach(c => {
            contenedor.innerHTML += `
                <div>
                    <label>${c.label}</label>
                    <input type="text" id="edit_${c.id}" value="${c.valor || ''}">
                </div>`;
        });

        document.getElementById('modalEditar').style.display = 'block';
        document.getElementById('btnGuardarEdit').onclick = guardarEdicion;
    }
    function abrirEditor(atleta) {
        atletaAEditar = atleta;
        const contenedor = document.getElementById('camposEditar');
        contenedor.innerHTML = "";
        const campos = [
            {id: "nombre", label: "Nombre"}, {id: "apellido", label: "Apellido"},
            {id: "cedula", label: "Cédula"}, {id: "telefono", label: "Teléfono"},
            {id: "correo", label: "Correo"}, {id: "talla", label: "Talla"},
            {id: "modalidad", label: "Modalidad"}, {id: "categoria", label: "Categoría"},
            {id: "dorsal", label: "Dorsal"}, {id: "fecha", label: "Fecha"}
        ];
        campos.forEach(c => {
            contenedor.innerHTML += `<div><label>${c.label}</label><input type="text" id="edit_${c.id}" value="${atleta[c.id] || ''}"></div>`;
        });
        document.getElementById('modalEditar').style.display = 'block';
        document.getElementById('btnGuardarEdit').onclick = guardarEdicion;
    }

    async function guardarEdicion() {
        const payload = {
            accion: "editar",
            fila: atletaAEditar.fila,
            nombre: document.getElementById('edit_nombre').value,
            apellido: document.getElementById('edit_apellido').value,
            cedula: document.getElementById('edit_cedula').value,
            telefono: document.getElementById('edit_telefono').value,
            correo: document.getElementById('edit_correo').value,
            talla: document.getElementById('edit_talla').value,
            modalidad: document.getElementById('edit_modalidad').value,
            categoria: document.getElementById('edit_categoria').value,
            dorsal: document.getElementById('edit_dorsal').value,
            fecha: document.getElementById('edit_fecha').value
        };
        if(!confirm("¿Guardar cambios?")) return;
        await fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
        document.getElementById('modalEditar').style.display = 'none';
        cargarAtletas();
    }

    async function eliminarAtleta(fila, n) {
        if(!confirm(`¿Eliminar a ${n}?`)) return;
        await fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ accion: "eliminar", fila: fila }) });
        cargarAtletas();
    }

    function actualizarControlesPagina(t) {
        const totalPaginas = Math.ceil(t / registrosPorPagina);
        document.getElementById('pageInfo').innerText = `Página ${paginaActual} de ${totalPaginas || 1}`;
        document.getElementById('prevPage').disabled = paginaActual === 1;
        document.getElementById('nextPage').disabled = paginaActual >= totalPaginas;
    }

    function cambiarPagina(d) { paginaActual += d; renderizarTabla(); window.scrollTo(0,0); }
    function resetearYPaginacion() { paginaActual = 1; aplicarFiltros(); }

    async function procesarAprobacion(f, c, n) {
        if(!confirm(`¿Aprobar a ${n}?`)) return;
        await fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ accion: "aprobar", fila: f, correo: c, nombre: n }) });
        cargarAtletas();
    }
</script>
</body>
</html>
